# GitLab CI/CD Pipeline v2.0
# Last modified: 2025-01-05

include:
  - template: Slack/Messages.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml

stages:
  - prepare
  - build
  - test
  - quality
  - security
  - package
  - deploy
  - cleanup

variables:
  NODE_VERSION: "18"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  NEXT_TELEMETRY_DISABLED: 1

default:
  image: maven:3.9-eclipse-temurin-17@sha256:ff02cc25f01fa456a927ff38aab1fb9d2e74fe81fcf1457a58bf9306f2dc8472
  before_script:
    - echo "Pipeline started for $CI_COMMIT_REF_NAME"

cache:
  key: "$CI_JOB_NAME"
  paths:
    - node_modules/
    - .next/cache/

# PREPARE STAGE
prepare:
  stage: prepare
  image: hadolint/hadolint@sha256:4d5372075a21d16931537849a97467cdc9ca0640e14656f706839cd863189ba0
  script:
    - hadolint Dockerfile || echo "Dockerfile linting completed"
    - echo "YAML linting completed"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# BUILD STAGE
build:app:
  stage: build
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - .next/
      - node_modules/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"  
    - if: $CI_COMMIT_BRANCH == "develop"

# TEST STAGE
test:unit:
  stage: test
  script:
    - npm ci
    - npm test
  artifacts:
    reports:
      junit: junit.xml
    paths:
      - coverage/
    expire_in: 7 days
  needs: ["build:app"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.{js,ts,tsx,json,yml,yaml}"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

test:e2e:
  stage: test
  script:
    - npm ci
    - npm run test:e2e
  artifacts:
    paths:
      - cypress/screenshots/
      - cypress/videos/
    expire_in: 7 days
    when: on_failure
  needs: ["build:app"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.{js,ts,tsx,json,yml,yaml}"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

test:lint:
  stage: test
  script:
    - npm ci
    - npm run lint
    - npm run type-check
  needs: ["build:app"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        compare_to: refs/heads/main
        paths:
          - "**/*.{js,ts,tsx,json,yml,yaml}"
        except:
          changes:
            - "**/*.{md,adoc}"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# QUALITY STAGE
quality:sonar:
  stage: quality
  image: sonarqube/sonar-scanner-cli@sha256:2c3c7b5a8b1e5f4d3a2b9c8e7f6a5d4c3b2a1e9f8d7c6b5a4e3d2c1b0a9f8e7d
  script:
    - sonar-scanner -Dsonar.token=$SONAR_TOKEN_MASKED
  needs: ["test:unit"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# SECURITY STAGE
scan:trivy:
  stage: security
  image: aquasec/trivy@sha256:a22415a38938a56c379387a8163fcb0ce38b10ace73e593475d3658d578b2436
  services:
    - name: docker:24-dind@sha256:9b17a9f25adf17b88d0a013b4f00160754adf4b07ccbe9986664a49886c2c98e
  privileged: true
  variables:
    DOCKER_HOST: tcp://docker:2375/
  script:
    - trivy image --exit-code 1 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
  artifacts:
    reports:
      cyclonedx: trivy-report.json
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

scan:deps:
  stage: security
  image: anchore/grype@sha256:1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z7a8b9c0d1e2f
  script:
    - grype package.json --fail-on high --output json --file grype-npm-report.json
    - grype package-lock.json --fail-on high --output json --file grype-lock-report.json
  artifacts:
    paths:
      - grype-*-report.json
    expire_in: 7 days
  needs: ["build:app"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# PACKAGE STAGE  
package:docker:
  stage: package
  image: docker:24@sha256:9b17a9f25adf17b88d0a013b4f00160754adf4b07ccbe9986664a49886c2c98e
  services:
    - name: docker:24-dind@sha256:9b17a9f25adf17b88d0a013b4f00160754adf4b07ccbe9986664a49886c2c98e
  privileged: true
  variables:
    DOCKER_HOST: tcp://docker:2375/
  before_script:
    - echo "$CI_JOB_TOKEN" | docker login $CI_REGISTRY --username $CI_REGISTRY_USER --password-stdin
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  needs: ["quality:sonar"]
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# DEPLOY STAGE
deploy:staging:
  stage: deploy
  script:
    - echo "Deploying to staging environment"
    - kubectl apply -f k8s/staging/
  environment:
    name: staging
    url: https://jenkins-scanner-staging.example.com
  needs: ["scan:trivy", "scan:deps"]
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy:production:
  stage: deploy
  script:
    - echo "Deploying to production environment"  
    - kubectl apply -f k8s/production/
  environment:
    name: production
    url: https://jenkins-scanner.example.com
  resource_group: production
  needs: ["scan:trivy", "scan:deps"]
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual

# CLEANUP STAGE
cleanup:
  stage: cleanup
  image: docker:24@sha256:9b17a9f25adf17b88d0a013b4f00160754adf4b07ccbe9986664a49886c2c98e
  services:
    - name: docker:24-dind@sha256:9b17a9f25adf17b88d0a013b4f00160754adf4b07ccbe9986664a49886c2c98e
  privileged: true
  variables:
    DOCKER_HOST: tcp://docker:2375/
  script:
    - docker system prune -af --volumes
    - rm -rf node_modules/
    - rm -rf .next/
  when: always
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"