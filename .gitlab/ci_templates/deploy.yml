# Deploy Template - DRY principle (Block 10)
# Reusable deployment configuration with environment management

.deploy_template: &deploy_template
  stage: deploy
  image: bitnami/kubectl:latest@sha256:8c0f8b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3d4e5f6
  before_script:
    - echo "ðŸš€ Preparing deployment to $ENVIRONMENT"
    - chmod +x ./scripts/deploy.sh
  script:
    - ./scripts/deploy.sh $ENVIRONMENT
    - kubectl apply -f k8s/$ENVIRONMENT/

.staging_deploy: &staging_deploy
  <<: *deploy_template
  environment:
    name: staging
    url: https://jenkins-scanner-staging.example.com
    deployment_tier: staging
    auto_stop_in: 7 days
  resource_group: jenkins-scanner-deploy-staging
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

.production_deploy: &production_deploy
  <<: *deploy_template
  environment:
    name: production
    url: https://jenkins-scanner.example.com
    deployment_tier: production
  resource_group: jenkins-scanner-deploy-production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual

.review_deploy: &review_deploy
  <<: *deploy_template
  environment:
    name: review/pr-$CI_MERGE_REQUEST_IID
    url: https://pr-$CI_MERGE_REQUEST_IID.jenkins-scanner-review.example.com
    deployment_tier: development
    on_stop: stop:review
    auto_stop_in: 3 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"